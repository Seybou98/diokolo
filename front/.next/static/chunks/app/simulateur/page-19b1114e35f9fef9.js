(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[79],{51293:function(e,t,n){Promise.resolve().then(n.bind(n,91315))},91315:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return q}});var i=n(57437),r=n(76351),l=n(93191),o=n(25524),s=n(9453),u=n(43118),d=n(17564),a=n(17121),c=n(38962),m=n(16463);let f=new Set;var p=n(74340),x=n(99240),h=n(2265),g=n(89386),v=n(64973),y=n(40191),b=n(19651),j=n(33596),S=n(62664),E=n(14937),C=n(86857);function w(e){let{options:t,onNext:n,isMulti:r,values:l,onChange:o}=e;return(0,i.jsx)(E.g,{spacing:10,children:t.map((e,t)=>{let{values:s,title:u}=e;return(0,i.jsxs)(p.xu,{children:[u&&(0,i.jsx)(y.x,{fontWeight:800,fontSize:18,color:"king",children:u}),(0,i.jsx)(C.E,{justify:"center",children:s.map(e=>{let{id:t,title:s,icon:u,subtitle:d}=e,a=l.includes(t);return(0,i.jsx)(C.U,{w:{base:"full",md:"unset"},children:(0,i.jsxs)(b.M,{cursor:"pointer",borderWidth:1,...l.includes(t)&&{borderColor:"primary"},onClick:()=>(function(e){if(r){let t=l;o(t=l.includes(e)?t.filter(t=>t!=e):[...t,e])}else o([e]),n([e])})(t),w:{base:"full",md:"200px"},maxW:{base:"350px",md:"unset"},h:{md:"180px"},bg:"white",boxShadow:{base:S.k,md:S.A},m:{base:1,md:5},mx:{base:"auto",md:"unset"},flexDir:{md:"column"},py:{base:2,md:6},px:{base:3,md:4},rounded:"md",position:"relative",...a&&{bg:"primaryLight",borderColor:"primary"},justifyContent:{base:"flex-start",md:"center"},children:[u&&(0,i.jsx)(v.E,{src:u,h:"50px"}),(0,i.jsx)(y.x,{mt:{md:2},ml:{base:2,md:0},userSelect:"none",textAlign:{base:"left",md:"unset"},children:s}),(0,i.jsx)(p.xu,{position:{md:"absolute"},rounded:"full",boxSize:"25px",minW:"25px",borderWidth:1,bg:"white",borderColor:"king",top:{md:2},ml:{base:"auto",md:"unset"},right:2,...a&&{borderColor:"primary",bg:"primary"}})]})},t)})})]},t)})})}var I=n(410),N=n(63680),k=n(39343),A=n(24896),O=n(64614);function D(e,t){return e.find(e=>e.id==t.id)?[...e.filter(e=>e.id!=t.id),t]:[...e,t]}var z=n(67016),R=n(4566),U=n(76550);function W(e){let{simulatorResult:t,onEnd:n,...r}=e,[l,o]=(0,h.useState)(!1),[s,u]=(0,h.useState)();if((0,h.useEffect)(()=>{(async()=>{await (0,R.Gg)()?n():u("signup")})()},[]),s&&!l){var d;return(0,i.jsxs)(p.xu,{pb:10,children:[(0,i.jsx)(y.x,{fontWeight:800,fontSize:20,mb:8,children:"Acc\xe9dez \xe0 votre estimation sur votre espace s\xe9curis\xe9"}),"signup"==s&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(O.Z,{defaultAddress:null!==(d=function(e){let t=e.find(e=>"adresse"==e.id);try{if(t)return JSON.parse(t.value.toString())}catch(e){console.error(e)}return null}(t))&&void 0!==d?d:void 0,onEnd:()=>{n(),o(!0)},...r}),(0,i.jsx)(y.x,{mt:10,mb:2,textAlign:"left",fontSize:18,fontWeight:500,color:"gray.500",children:"D\xe9j\xe0 un compte ?"}),(0,i.jsx)(j.default,{onClick:()=>u("login"),children:"Me connecter"})]}),"login"==s&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(U.Z,{mx:"auto",onSuccess:()=>{n(),o(!0)},displayForgotPassword:!1}),(0,i.jsx)(y.x,{mt:10,mb:2,textAlign:"left",fontSize:18,fontWeight:500,color:"gray.500",children:"Pas encore de compte ?"}),(0,i.jsx)(j.default,{onClick:()=>u("signup"),children:"Cr\xe9er mon compte"})]})]})}return(0,i.jsx)(z.Z,{h:"full",children:"Enregistrement de votre simulation..."})}let F=["input-number","input-moreless","input-address","input-text","select-multi"];function T(e){let{id:t,title:n,type:r,bigTitle:l,label:o,mask:s,max:u,onNext:a,onPrevious:c,subtitle:m,tag:f,values:b,valuesSection:j,displayOnNext:S=!1,defaultValue:E,simulatorResult:C,onEnd:O}=e,[D,z]=(0,h.useState)(null!=E?E:""),R=(0,k.cI)();function U(){D&&(!Array.isArray(D)||D.length>0)&&a(D)}function T(e){"Enter"==e.code&&U()}return(0,h.useEffect)(()=>{z(null!=E?E:"")},[E,r,t]),(0,h.useEffect)(()=>(document.addEventListener("keydown",T),()=>{document.removeEventListener("keydown",T)}),[D]),(0,i.jsxs)(x.k,{alignItems:"center",flexDir:"column",h:"full",px:{base:5,lg:10},children:[c&&(0,i.jsxs)(g.U,{position:"fixed",top:{base:"90px",lg:"130px"},left:0,onClick:c,cursor:"pointer",zIndex:1,bg:"white",px:5,py:1,rounded:"full",children:[(0,i.jsx)(v.E,{src:"/icons/fleche.png",w:"25px",transform:"rotate(180deg)"}),(0,i.jsx)(y.x,{fontWeight:700,color:"primary",userSelect:"none",children:"Retour"})]}),f&&(0,i.jsx)(y.x,{bg:"primaryLight",color:"primary",fontWeight:600,py:4,px:{base:10,lg:20},w:"fit-content",rounded:"full",children:f}),l&&(0,i.jsx)(y.x,{as:"h1",my:10,fontSize:{base:25,lg:35},fontWeight:800,children:l}),(0,i.jsxs)(p.xu,{mt:{base:l?10:"70px",md:l?10:20},mb:8,children:[n&&(0,i.jsx)(y.x,{fontWeight:800,fontSize:20,mb:3,children:n}),m&&(0,i.jsx)(y.x,{color:"gray.400",fontWeight:500,children:m})]}),["signup"].includes(r)&&(0,i.jsx)(W,{mt:4,simulatorResult:C.map(e=>({...e,value:Array.isArray(e.value)?e.value.map(e=>e.toString()):[e.value.toString()]})),onEnd:async()=>{try{let e=d.I.currentUser;if(!e)throw Error("Authentication required");await e.getIdToken(!0),O()}catch(e){console.error("Submission error:",e)}}}),(0,i.jsxs)(p.xu,{as:N.l0,h:"full",form:R,w:"100%",position:"relative",onSubmit:()=>{U()},children:[["select","select-multi"].includes(r)&&(()=>{var e;let t=void 0!=u&&D.length>u;return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(w,{options:null!==(e=b?[{values:b}]:j)&&void 0!==e?e:[],isMulti:"select-multi"==r,onNext:a,values:null!=D?D:[],onChange:e=>z(e)}),"select-multi"==r&&(0,i.jsx)(M,{onClick:()=>a(D),isDisabled:D.length<1||t,error:t?"Vous pouvez choisir au maximum ".concat(u," \xe9l\xe9ments"):void 0,children:"CONTINUER"})]})})(),["input-number","input-moreless"].includes(r)&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(I.I,{label:o,value:D.toString(),type:"number",onChange:e=>{z(e.target.value)}}),(0,i.jsx)(M,{onClick:()=>a(D),isDisabled:isNaN(parseInt(D.toString()))||0>=parseInt(D.toString()),children:"CONTINUER"})]}),["input-text"].includes(r)&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(I.I,{label:o,value:D.toString(),onChange:e=>{z(e.currentTarget.value)}}),(0,i.jsx)(M,{onClick:()=>a(D),isDisabled:D.toString().length<1,children:"CONTINUER"})]}),["input-address"].includes(r)&&(()=>{let e;try{let t=JSON.parse(D.toString());(null==t?void 0:t.address)&&(e=t)}catch(e){}return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(A.r,{label:o,value:e,onChangeValue:e=>{z(JSON.stringify(e))}}),(0,i.jsx)(M,{onClick:()=>a(D),isDisabled:!e,children:"CONTINUER"})]})})(),a&&S&&!F.includes(r)&&(0,i.jsx)(M,{onClick:()=>a(),children:"CONTINUER"})]})]})}function M(e){let{error:t,...n}=e;return(0,i.jsxs)(b.M,{flexDir:"column",my:{base:3,lg:3},children:[t&&(0,i.jsx)(y.x,{color:"red",my:1,top:5,children:t}),(0,i.jsx)(j.default,{...n,children:"CONTINUER"})]})}var _=n(54969);function L(e){let{progress:t}=e;return(0,i.jsx)(p.xu,{position:"fixed",top:{base:"60px",lg:"100px"},left:0,right:0,h:"10px",zIndex:1,children:(0,i.jsx)(p.xu,{h:"full",w:"".concat(Math.max(Math.min(100,100*t),1),"%"),bgGradient:"linear(to-r,secondary,primary)",roundedRight:"full",transition:"all .4s"})})}let P=[];function J(){var e;let t=(0,m.useRouter)(),{data:n,isLoading:g}=(0,r.useQuery)({queryKey:s.a.tree(),queryFn:async()=>{try{var e;let t=await (null===(e=d.I.currentUser)||void 0===e?void 0:e.getIdToken());console.log("API URL:","https://label-energie-api.onrender.com");let{data:n}=await u.hi.get("/simulator/tree",{headers:t?{Authorization:"Bearer ".concat(t)}:{}});return n}catch(e){throw console.error("Failed to fetch simulator tree:",e),e}},staleTime:3e5,retry:2}),{mutate:v}=function(){let e=(0,l.useQueryClient)(),t=(0,m.useRouter)();return(0,o.useMutation)({mutationFn:async e=>{let t=Date.now().toString();if(f.size>0)throw Error("Une op\xe9ration est d\xe9j\xe0 en cours");f.add(t);try{let t=d.I.currentUser;if(!t)throw Error("User not authenticated");let n=new Date,i={name:"Simulation ".concat(n.toLocaleDateString("fr-FR")),userId:t.uid,status:{id:c.S.Pending,label:"En attente",color:"#FFA500"},products:e.simulation.map(e=>({id:e.id,type:e.type,value:Array.isArray(e.value)?e.value:[e.value]})),documents:[],date:n,createdAt:n.toISOString(),updatedAt:n.toISOString()};return(await (0,a.ET)((0,a.hJ)(d.db,"folders"),i)).id}finally{f.delete(t)}},onSuccess:n=>{e.invalidateQueries({queryKey:s.Wg.list(),exact:!0}),console.log("Dossier cr\xe9\xe9 avec succ\xe8s:",n),t.push("/app/mon-compte/mes-dossiers")},onError:e=>{console.error("Erreur cr\xe9ation simulation:",e)}})}(),[y,b]=(0,h.useState)([]),[j,S]=(0,h.useState)([]),[E,C]=(0,h.useState)(),[w,I]=(0,h.useState)(!1),N=(0,h.useMemo)(()=>{var e;return null!==(e=null==n?void 0:n.findIndex(e=>e.id==(null==E?void 0:E.id.split(".")[0])))&&void 0!==e?e:0},[n,E]),k=(0,h.useMemo)(()=>{var e;return N/(null!==(e=null==n?void 0:n.length)&&void 0!==e?e:1)},[n,N]);function A(){let e=P.pop();e&&C(e)}function O(){let e=document.getElementById("main-scroll");null==e||e.scrollTo({top:0})}return(0,h.useEffect)(()=>{n&&C(n[0])},[n]),(0,i.jsxs)(p.xu,{h:{base:"calc(100vh - 60px)",lg:"calc(100vh - 100px)"},position:"relative",pt:{base:5,lg:10},children:[g&&(0,i.jsx)(z.Z,{h:"full",children:"Chargement du simulateur..."}),!g&&!w&&E&&(0,i.jsxs)(x.k,{flexDir:"column",textAlign:"center",alignItems:"center",h:"full",children:[(0,i.jsx)(L,{progress:k}),(0,i.jsx)(T,{onNext:async e=>{var t;e&&["select","select-multi"].includes(E.type)&&await (0,_._)(200),function(e){if(!E||!n||void 0==e)return;let t={id:E.id,type:E.type,value:e};if(b(e=>D(e,t)),S(e=>D(e,t)),P.length>0){A();return}let i=E.dependencies;E.idfDependencies&&function(e){var t,n,i;let r=null===(t=e.find(e=>"type-occupant.proprio-second.code-postal"==e.id))||void 0===t?void 0:t.value.toString();if(!r)try{r=JSON.parse(null!==(i=null===(n=e.find(e=>"adresse"==e.id))||void 0===n?void 0:n.value.toString())&&void 0!==i?i:"{}").zipCode}catch(e){console.error(e)}return!!r&&["75","77","78","91","92","93","94","95"].includes(r[0]+r[1])}(y)&&(i=E.idfDependencies);let r=[];if(Array.isArray(e))for(let t of e){let e=null==i?void 0:i[t];e&&r.push(...e.map(e=>({...e,id:"".concat(E.id,".").concat(t,".").concat(e.id)})))}else{let t=null==i?void 0:i[e.toString()];(null==t?void 0:t.length)&&r.push(...t.map(t=>({...t,id:"".concat(E.id,".").concat(e,".").concat(t.id)})))}r.length?(P=[...r].reverse(),A()):n.length-1>N&&C(n[N+1]),O()}(null!=e?e:null===(t=j.find(e=>e.id==(null==E?void 0:E.id)))||void 0===t?void 0:t.value)},simulatorResult:y,displayOnNext:void 0!=j.find(e=>e.id==E.id),onPrevious:N>0?function(){if(!n)return;let e=y[y.length-1];if(e.id.includes(".")){var t,i;let[r,l,o]=e.id.split("."),s=null===(i=n.find(e=>e.id==r))||void 0===i?void 0:null===(t=i.dependencies)||void 0===t?void 0:t[l].find(e=>e.id==o);if(!s)return;(null==E?void 0:E.id.includes("."))&&P.push(E),C({...s,id:e.id})}else C(n.find(t=>t.id==e.id)),P=[];b(t=>t.filter(t=>t.id!=e.id)),O()}:void 0,defaultValue:null===(e=j.find(e=>e.id==E.id))||void 0===e?void 0:e.value,onEnd:function(){v({simulation:y},{onSuccess(){t.push("/app/mon-compte/mes-dossiers")},onError(){I(!0)}})},...E})]})]})}function q(){return(0,i.jsx)(J,{})}}},function(e){e.O(0,[351,335,744],function(){return e(e.s=51293)}),_N_E=e.O()}]);